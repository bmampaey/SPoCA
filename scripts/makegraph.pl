#!/usr/bin/perl
# Script makegraph.pl Written by Benjamin Mampaey on 16 November 2010
# This script will output a dot graph of the edge reference of voevents xml files

use strict;
use XML::Simple; 
use File::Basename;

my @filenames;
 
my $graphfile = "graph.dot";
 
sub parse_arguments
{
	my $help = undef;
	if (@ARGV == 0)
	{
		$help = 1;
	}
	else
	{
		use Getopt::Long;
		GetOptions(
	            "h"=>\$help,
	            "o:s"=>\$graphfile,
		);
	}


	@filenames = @ARGV or $help = 1;
	
	if ($help == 1)
	{
		print STDERR "Usage: makegraph.pl -o graph.dot voevent1.xml voevent2.xml ... \n";
		print STDERR "This script output a dot graph of the edge reference of voevents xml files.\n";
		exit(2);

	}
}

parse_arguments();

my @dot_gradient = ("\"0, 0, 0\"", "\"0.17, 1.00, 1.00\"", "\"0.50, 1.00, 1.00\"", "\"0.83, 1.00, 1.00\"", "\"0.08, 1.00, 1.00\"", "\"0.25, 1.00, 1.00\"", "\"0.42, 1.00, 1.00\"", "\"0.58, 1.00, 1.00\"", "\"0.75, 1.00, 1.00\"", "\"0.92, 1.00, 1.00\"", "\"0.21, 1.00, 1.00\"", "\"0.54, 1.00, 1.00\"", "\"0.88, 1.00, 1.00\"", "\"0.12, 1.00, 1.00\"", "\"0.46, 1.00, 1.00\"", "\"0.79, 1.00, 1.00\"", "\"0.17, 1.00, 0.75\"", "\"0.50, 1.00, 0.75\"", "\"0.83, 1.00, 0.75\"", "\"0.08, 1.00, 0.75\"", "\"0.25, 1.00, 0.75\"", "\"0.42, 1.00, 0.75\"", "\"0.58, 1.00, 0.75\"", "\"0.75, 1.00, 0.75\"", "\"0.92, 1.00, 0.75\"", "\"0.21, 1.00, 0.75\"", "\"0.54, 1.00, 0.75\"", "\"0.88, 1.00, 0.75\"", "\"0.12, 1.00, 0.75\"", "\"0.46, 1.00, 0.75\"", "\"0.79, 1.00, 0.75\"", "\"0.17, 1.00, 0.88\"", "\"0.50, 1.00, 0.88\"", "\"0.83, 1.00, 0.88\"", "\"0.08, 1.00, 0.88\"", "\"0.25, 1.00, 0.88\"", "\"0.42, 1.00, 0.88\"", "\"0.58, 1.00, 0.88\"", "\"0.75, 1.00, 0.88\"", "\"0.92, 1.00, 0.88\"", "\"0.21, 1.00, 0.88\"", "\"0.54, 1.00, 0.88\"", "\"0.88, 1.00, 0.88\"", "\"0.12, 1.00, 0.88\"", "\"0.46, 1.00, 0.88\"", "\"0.79, 1.00, 0.88\"", "\"0.17, 1.00, 0.62\"", "\"0.50, 1.00, 0.62\"", "\"0.83, 1.00, 0.62\"", "\"0.08, 1.00, 0.62\"", "\"0.25, 1.00, 0.62\"", "\"0.42, 1.00, 0.62\"", "\"0.58, 1.00, 0.62\"", "\"0.75, 1.00, 0.62\"", "\"0.92, 1.00, 0.62\"", "\"0.21, 1.00, 0.62\"", "\"0.54, 1.00, 0.62\"", "\"0.88, 1.00, 0.62\"", "\"0.12, 1.00, 0.62\"", "\"0.46, 1.00, 0.62\"", "\"0.79, 1.00, 0.62\"", "\"0.17, 1.00, 0.94\"", "\"0.50, 1.00, 0.94\"", "\"0.83, 1.00, 0.94\"", "\"0.08, 1.00, 0.94\"", "\"0.25, 1.00, 0.94\"", "\"0.42, 1.00, 0.94\"", "\"0.58, 1.00, 0.94\"", "\"0.75, 1.00, 0.94\"", "\"0.92, 1.00, 0.94\"", "\"0.21, 1.00, 0.94\"", "\"0.54, 1.00, 0.94\"", "\"0.88, 1.00, 0.94\"", "\"0.12, 1.00, 0.94\"", "\"0.46, 1.00, 0.94\"", "\"0.79, 1.00, 0.94\"", "\"0.17, 1.00, 0.69\"", "\"0.50, 1.00, 0.69\"", "\"0.83, 1.00, 0.69\"", "\"0.08, 1.00, 0.69\"", "\"0.25, 1.00, 0.69\"", "\"0.42, 1.00, 0.69\"", "\"0.58, 1.00, 0.69\"", "\"0.75, 1.00, 0.69\"", "\"0.92, 1.00, 0.69\"", "\"0.21, 1.00, 0.69\"", "\"0.54, 1.00, 0.69\"", "\"0.88, 1.00, 0.69\"", "\"0.12, 1.00, 0.69\"", "\"0.46, 1.00, 0.69\"", "\"0.79, 1.00, 0.69\"", "\"0.17, 1.00, 0.81\"", "\"0.50, 1.00, 0.81\"", "\"0.83, 1.00, 0.81\"", "\"0.08, 1.00, 0.81\"", "\"0.25, 1.00, 0.81\"", "\"0.42, 1.00, 0.81\"", "\"0.58, 1.00, 0.81\"", "\"0.75, 1.00, 0.81\"", "\"0.92, 1.00, 0.81\"", "\"0.21, 1.00, 0.81\"", "\"0.54, 1.00, 0.81\"", "\"0.88, 1.00, 0.81\"", "\"0.12, 1.00, 0.81\"", "\"0.46, 1.00, 0.81\"", "\"0.79, 1.00, 0.81\"", "\"0.17, 0.50, 1.00\"", "\"0.50, 0.50, 1.00\"", "\"0.83, 0.50, 1.00\"", "\"0.08, 0.50, 1.00\"", "\"0.25, 0.50, 1.00\"", "\"0.42, 0.50, 1.00\"", "\"0.58, 0.50, 1.00\"", "\"0.75, 0.50, 1.00\"", "\"0.92, 0.50, 1.00\"", "\"0.21, 0.50, 1.00\"", "\"0.54, 0.50, 1.00\"", "\"0.88, 0.50, 1.00\"", "\"0.12, 0.50, 1.00\"", "\"0.46, 0.50, 1.00\"", "\"0.79, 0.50, 1.00\"", "\"0.17, 0.50, 0.75\"", "\"0.50, 0.50, 0.75\"", "\"0.83, 0.50, 0.75\"", "\"0.08, 0.50, 0.75\"", "\"0.25, 0.50, 0.75\"", "\"0.42, 0.50, 0.75\"", "\"0.58, 0.50, 0.75\"", "\"0.75, 0.50, 0.75\"", "\"0.92, 0.50, 0.75\"", "\"0.21, 0.50, 0.75\"", "\"0.54, 0.50, 0.75\"", "\"0.88, 0.50, 0.75\"", "\"0.12, 0.50, 0.75\"", "\"0.46, 0.50, 0.75\"", "\"0.79, 0.50, 0.75\"", "\"0.17, 0.50, 0.88\"", "\"0.50, 0.50, 0.88\"", "\"0.83, 0.50, 0.88\"", "\"0.08, 0.50, 0.88\"", "\"0.25, 0.50, 0.88\"", "\"0.42, 0.50, 0.88\"", "\"0.58, 0.50, 0.88\"", "\"0.75, 0.50, 0.88\"", "\"0.92, 0.50, 0.88\"", "\"0.21, 0.50, 0.88\"", "\"0.54, 0.50, 0.88\"", "\"0.88, 0.50, 0.88\"", "\"0.12, 0.50, 0.88\"", "\"0.46, 0.50, 0.88\"", "\"0.79, 0.50, 0.88\"", "\"0.17, 0.50, 0.62\"", "\"0.50, 0.50, 0.62\"", "\"0.83, 0.50, 0.62\"", "\"0.08, 0.50, 0.62\"", "\"0.25, 0.50, 0.62\"", "\"0.42, 0.50, 0.62\"", "\"0.58, 0.50, 0.62\"", "\"0.75, 0.50, 0.62\"", "\"0.92, 0.50, 0.62\"", "\"0.21, 0.50, 0.62\"", "\"0.54, 0.50, 0.62\"", "\"0.88, 0.50, 0.62\"", "\"0.12, 0.50, 0.62\"", "\"0.46, 0.50, 0.62\"", "\"0.79, 0.50, 0.62\"", "\"0.17, 0.50, 0.94\"", "\"0.50, 0.50, 0.94\"", "\"0.83, 0.50, 0.94\"", "\"0.08, 0.50, 0.94\"", "\"0.25, 0.50, 0.94\"", "\"0.42, 0.50, 0.94\"", "\"0.58, 0.50, 0.94\"", "\"0.75, 0.50, 0.94\"", "\"0.92, 0.50, 0.94\"", "\"0.21, 0.50, 0.94\"", "\"0.54, 0.50, 0.94\"", "\"0.88, 0.50, 0.94\"", "\"0.12, 0.50, 0.94\"", "\"0.46, 0.50, 0.94\"", "\"0.79, 0.50, 0.94\"", "\"0.17, 0.50, 0.69\"", "\"0.50, 0.50, 0.69\"", "\"0.83, 0.50, 0.69\"", "\"0.08, 0.50, 0.69\"", "\"0.25, 0.50, 0.69\"", "\"0.42, 0.50, 0.69\"", "\"0.58, 0.50, 0.69\"", "\"0.75, 0.50, 0.69\"", "\"0.92, 0.50, 0.69\"", "\"0.21, 0.50, 0.69\"", "\"0.54, 0.50, 0.69\"", "\"0.88, 0.50, 0.69\"", "\"0.12, 0.50, 0.69\"", "\"0.46, 0.50, 0.69\"", "\"0.79, 0.50, 0.69\"", "\"0.17, 0.50, 0.81\"", "\"0.50, 0.50, 0.81\"", "\"0.83, 0.50, 0.81\"", "\"0.08, 0.50, 0.81\"", "\"0.25, 0.50, 0.81\"", "\"0.42, 0.50, 0.81\"", "\"0.58, 0.50, 0.81\"", "\"0.75, 0.50, 0.81\"", "\"0.92, 0.50, 0.81\"", "\"0.21, 0.50, 0.81\"", "\"0.54, 0.50, 0.81\"", "\"0.88, 0.50, 0.81\"", "\"0.12, 0.50, 0.81\"", "\"0.46, 0.50, 0.81\"", "\"0.79, 0.50, 0.81\"");
my $last_color = 0;
my %colors;
my %ranks;

open GRAPH, ">", $graphfile or die "Error opening file $graphfile: $!";

print GRAPH "digraph voevents_relations {\n";
print GRAPH "node [penwidth=4, shape=box, fontsize=15, margin=0.1];\n";


foreach my $filename (@filenames)
{
	my $xml = new XML::Simple;	
	my $data = $xml->XMLin($filename) or die "Error parsing file $filename: $!";
	my $ivorn = undef;
	if ($data->{ivorn} =~ m#.*/([0-9a-zA-Z_]+)$#)
	{
		$ivorn = $1;
	}
	else
	{
		die "No ivorn found in $filename";
	}
	
	my $color = $data->{How}->{Group}->{Param}->{FRM_SPECIFICID}->{value};
	die "No FRM_SPECIFICID found in $filename" if !defined $color;
	
	if (! defined $colors{$color})
	{
		++$last_color;
		$colors{$color} = $dot_gradient[$last_color];
	}
	
	my $date = $data->{WhereWhen}->{ObsDataLocation}->{ObservationLocation}->{AstroCoords}->{Time}->{TimeInstant}->{ISOTime};
	die "No TimeInstant found in $filename" if !defined $date;
	
	$ranks{$date} .= "$ivorn;";
	
	my $area_raw = $data->{What}->{Group}->{Param}->{AREA_RAW}->{value};
	my $area_real = $data->{What}->{Group}->{Param}->{AREA_ATDISKCENTER}->{value};
	my $cx = $data->{WhereWhen}->{ObsDataLocation}->{ObservationLocation}->{AstroCoords}->{Position2D}->{Value2}->{C1};
	my $cy = $data->{WhereWhen}->{ObsDataLocation}->{ObservationLocation}->{AstroCoords}->{Position2D}->{Value2}->{C2};
	
	# I have all the info about the node, I write it
	
	my $label = "ivorn:\t$ivorn\\l";
	$label .= "color:\t$color\\l";
	$label .= $area_raw ? "area_raw:\t$area_raw Mm2\\l" : "area_raw:\tNA\\l";
	$label .= $area_real? "area_real:\t$area_real Mm2\\l" : "area_real:\tNA\\l";
	$label .= "center:\t($cx, $cy)\\l";
	
	print GRAPH "$ivorn [color=".$colors{$color}.", label=\"$label\"];\n";
	
	# We take care of the edges
	foreach my $edge ($data->{Reference}->{Edge})
	{
		next if(!defined $edge);
		my $type = $edge->{type};
		die "No type found in edge of $filename" if !defined $type;
		my $uri = undef;
		if ($edge->{uri} =~ m#.*/([0-9a-zA-Z_]+)$#)
		{
			$uri = $1;
		}
		else
		{
			die "No uri found in edge of $filename";
		}
		print GRAPH "$ivorn -> $uri [label=\"$type\"];\n";
		
	}


}

# We output the ranks so all evvents of the same date are on the same rank
foreach my $rank (values %ranks)
{
	print GRAPH "{ rank=same; $rank }\n";
}

print GRAPH "}\n";
close GRAPH;

# We try to generate a ps file with dot
my($file, $directories, $suffix) = fileparse($graphfile, qr/\.[^.]*$/);
my $pngfile = $directories.$file.".png";

my $error = `dot -Tpng $graphfile -o $pngfile 2>&1`;
if ($? >> 8 != 0)
{
	print STDERR "Warning: Could not generate png file :$error\n";
}

